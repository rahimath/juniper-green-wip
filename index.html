<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juniper Green</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            text-align: center;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        .grid {
            display: grid;
            gap: 10px;
            margin: auto;
            visibility: hidden;
        }
        .number {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background-color: gray;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease;
            height: 60px;
            width: 60px;
        }
        .selected {
            background-color: #333;
            color: #888;
        }
        .disabled {
            pointer-events: none;
        }
        select {
            margin-bottom: 20px;
            font-size: 16px;
            position: absolute;
            top: 20px;
            background-color: #171717;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 30px;
            appearance: none;
            width: 200px;
            text-align: center;
            font-family: inherit;
        }
        .selected-numbers {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            text-align: center;
            font-size: 24px;
            font-weight: normal;
            display: none;
            overflow-wrap: break-word;
            word-wrap: break-word;
            line-height: 1.8;
        }
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            position: relative;
        }
        .control-btn svg {
            width: 32px;
            height: 32px;
            fill: none;
            transition: fill 0.2s ease;
        }
        .control-btn:hover svg {
            fill: none;
        }
        .control-btn svg path {
            transition: stroke 0.2s ease;
        }
        .control-btn:hover svg path {
            stroke: gray;
        }
        .control-btn.cancel::after {
            content: "Annuler";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #080808;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 2001;
            pointer-events: none;
            margin-top: -5px;
            opacity: 0;
            transition: opacity 0.2s ease 0s;
        }
        .control-btn.restart::after {
            content: "Recommencer";
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #080808;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 2001;
            pointer-events: none;
            margin-top: -5px;
            opacity: 0;
            transition: opacity 0.2s ease 0s;
        }
        .control-btn.cancel:hover::after,
        .control-btn.restart:hover::after {
            opacity: 1;
            transition-delay: 0.2s;
        }
        .counter {
            color: white;
            font-size: 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            margin-right: 18px;
            margin-bottom: 5px;
            transition: text-shadow 0.4s ease;
        }
        .counter.glow {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8),
                         0 0 20px rgba(255, 255, 255, 0.6),
                         0 0 30px rgba(255, 255, 255, 0.4);
        }
        .menu {
            position: absolute;
            top: 20px;
            left: 20px;
        }
        .menu-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 18px;
            padding: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 10%;
            left: 20px;
            transform: translateY(0);
            background: #171717;
            padding: 20px;
            padding-top: 5px;
            padding-bottom: 5px;
            border-radius: 10px;
            z-index: 1000;
            width: 300px;
            text-align: left;
            max-height: 86vh;
            overflow-y: auto;
        }
        .modal ul {
            list-style: none;
            padding: 0;
        }
        .modal li {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        .modal li span {
            font-weight: bold;
            margin-left: 10px;
            text-align: right;
            min-width: 50px;
        }
        .gold-score {
            color: #D4AF37;
        }
        .game-over-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #171717;
            padding: 40px 60px;
            border-radius: 20px;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            overflow: visible;
        }
        .game-over-modal h2 {
            margin: 0 0 20px 0;
            font-size: 32px;
            color: white;
        }
        .game-over-modal p {
            margin: 10px 0;
            font-size: 20px;
            color: #ccc;
        }
        .game-over-modal .score {
            font-size: 48px;
            font-weight: 600;
            margin: 20px 0;
            transition: text-shadow 1s ease;
        }
        .game-over-modal .score.glow {
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8),
                         0 0 30px rgba(255, 255, 255, 0.6),
                         0 0 45px rgba(255, 255, 255, 0.4);
        }
        .game-over-modal .gold {
            color: #D4AF37;
        }
        .game-over-modal .gold.glow {
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.9),
                         0 0 30px rgba(212, 175, 55, 0.7),
                         0 0 45px rgba(212, 175, 55, 0.5);
        }
        .game-over-modal .sequence-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .game-over-modal .sequence-container {
            background: #222;
            border-radius: 10px;
            padding: 5px 15px;
            height: 30px;
            min-width: 350px;
            max-width: 550px;
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
            white-space: nowrap;
            display: flex;
            align-items: center;
            flex-shrink: 1;
        }
        .game-over-modal .sequence-text {
            font-size: 16px;
            color: #ccc;
            display: inline-block;
            line-height: 30px;
        }
        .game-over-modal .copy-icon-btn {
            background: none;
            border: none;
            padding: 5px;
            margin: 7.5px 10px 7.5px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            height: 30px;
        }
        .game-over-modal .copy-icon-btn:hover {
            opacity: 1;
        }
        .game-over-modal .copy-icon-btn::after {
            content: "Copier";
            position: fixed;
            background: #080808;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 2001;
            pointer-events: none;
            margin-top: 70px;
            opacity: 0;
            transition: opacity 0.2s ease 0s;
        }
        .game-over-modal .copy-icon-btn:hover::after {
            opacity: 1;
            transition-delay: 0.2s; /* d√©lai avant apparition */
        }
        .game-over-modal .copy-icon-btn svg {
            width: 20px;
            height: 20px;
            stroke: white;
            fill: none;
        }
        .game-over-modal .copy-btn {
            margin-top: 10px;
            padding: 8px 20px;
            font-size: 14px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .game-over-modal .copy-btn:hover {
            background-color: #555;
        }
        .game-over-modal button {
            margin-top: 30px;
            margin: 15px 10px 0 10px;
            padding: 11px 30px;
            font-size: 18px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .game-over-modal button:hover {
            background-color: #222;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1999;
            backdrop-filter: blur(2px); /* Optionnel : l√©ger flou derri√®re */
        }
        .confetti {
            position: fixed;
            top: -10px;
            z-index: 10000;
            opacity: 1;
            border-radius: 0px;
            pointer-events: none;
        }
        /* Nouveau style pour le bouton de classement global */
        .global-ranking-btn {
            position: absolute;
            bottom: 20px; /* Position en bas */
            right: 20px; /* Position √† droite */
            background-color: #D4AF37; /* Couleur or */
            color: #171717;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .global-ranking-btn:hover {
            background-color: #EBC144;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
        }
        /* Centrage du modal global et style am√©lior√© */
        #globalRankingModal {
            display: none;
            position: fixed; 
            top: 50% !important; 
            left: 50% !important; 
            transform: translate(-50%, -50%) !important; 
            width: 90% !important; /* Pourcentage de la largeur */
            max-width: 800px; 
            height: 85% !important; /* Pourcentage de la hauteur */
            background: #171717;
            padding: 20px;
            border-radius: 20px;
            z-index: 2000; 
            overflow-y: auto; 
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        #globalRankingModal h3 {
            font-size: 26px;
            margin-bottom: 25px !important;
            color: #D4AF37;
            text-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
            text-align: center;
        }

        #globalRankingModal ul {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 12px; /* Espace entre les entr√©es */
        }

        /* --- NOUVEAU STYLE POUR LA CROIX SVG --- */
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            z-index: 2001;
            transition: opacity 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            transform: scale(1.1);
        }

        .close-btn svg {
            width: 32px;
            height: 32px;
            stroke: #fff;
            stroke-width: 2.5;
            stroke-linecap: round;
        }

        /* Style de chaque entr√©e du classement */
        .ranking-entry {
            display: flex !important;
            justify-content: flex-start !important; /* Alignement √† gauche */
            align-items: center;
            background-color: #2b2b2b;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }

        .ranking-entry:hover {
            background-color: #333;
            transform: translateY(-2px);
        }

        .rank-badge {
            font-size: 22px;
            font-weight: bold;
            min-width: 40px; /* Espace pour le badge/rang */
            text-align: center;
            color: #ccc;
        }

        .info-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-grow: 1;
            margin-left: 15px;
        }

        .name-class {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .rank-name {
            font-size: 18px;
            font-weight: 600;
        }

        .rank-class {
            font-size: 14px;
            color: #999;
            margin-top: 2px;
        }

        .rank-score {
            text-align: right;
            display: flex;
            flex-direction: column;
        }

        .score-value {
            font-size: 24px;
            font-weight: 700;
            color: #69F0AE; /* Couleur vive pour les scores */
        }

        .score-unit {
            font-size: 12px;
            color: #999;
        }

        /* Styles sp√©ciaux pour le Top 3 */
        .ranking-entry.top-three {
            background: linear-gradient(90deg, #3a3a3a, #443c2c);
            border: 1px solid #D4AF37;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
        }

        .ranking-entry.top-three .rank-badge {
            font-size: 28px;
        }

        .ranking-entry.top-three .score-value {
            color: #FFEB3B; /* Or pour le score du Top 3 */
        }

        /* Style pour Mme Butin (Professeur) */
        .ranking-entry.teacher-entry {
            opacity: 0.7;
            font-style: italic;
            background-color: #383838;
        }

        .ranking-entry.teacher-entry .score-value {
            color: #81D4FA; /* Bleu pour les professeurs, par exemple */
        }
    </style>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3N5SVBSN6Q"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'G-3N5SVBSN6Q');
        </script>
    
</head>
<body>
    <div class="menu">
        <button class="menu-btn" onclick="toggleModal()">Classement</button>
    </div>

    <div id="rankingModal" class="modal">
        <ul id="rankingList"></ul>
    </div>

    <select id="numberCount">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="25">25</option>
        <option value="30" selected>30</option>
        <option value="40">40</option>
        <option value="50">50</option>
        <option value="60">60</option>
        <option value="70">70</option>
        <option value="80">80</option>
        <option value="90">90</option>
        <option value="100">100</option>
    </select>

    <div class="controls">
        <div class="counter" id="counter">0</div>
        <button class="control-btn cancel" onclick="undoLastMove()">
            <svg xmlns="http://www.w3.org/2000/svg" width="800px" height="800px" viewBox="0 0 24 24" fill="none">
                <path d="M7 11L3 15M3 15L7 19M3 15H16C18.7614 15 21 12.7614 21 10C21 7.23858 18.7614 5 16 5H11" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <button class="control-btn restart" onclick="resetSequence()">
            <svg xmlns="http://www.w3.org/2000/svg" width="800px" height="800px" viewBox="0 0 24 24" fill="none">
                <path d="M14 16H19V21M10 8H5V3M19.4176 9.0034C18.8569 7.61566 17.9181 6.41304 16.708 5.53223C15.4979 4.65141 14.0652 4.12752 12.5723 4.02051C11.0794 3.9135 9.58606 4.2274 8.2627 4.92661C6.93933 5.62582 5.83882 6.68254 5.08594 7.97612M4.58203 14.9971C5.14272 16.3848 6.08146 17.5874 7.29157 18.4682C8.50169 19.3491 9.93588 19.8723 11.4288 19.9793C12.9217 20.0863 14.4138 19.7725 15.7371 19.0732C17.0605 18.374 18.1603 17.3175 18.9131 16.0239" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>

    <div class="grid" id="grid"></div>
    <div class="selected-numbers" id="selectedNumbers"></div>
    
    <div class="overlay" id="overlay"></div>

    <div class="game-over-modal" id="gameOverModal">
        <h2 id="modalTitle">Partie termin√©e !</h2>
        <p id="modalMessage"></p>
        <div class="score" id="modalScore"></div>
        <div class="sequence-wrapper">
            <div class="sequence-container">
                <div class="sequence-text" id="modalSequence"></div>
            </div>
            <button class="copy-icon-btn" onclick="copySequence()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
        </div>
        <div>
            <button onclick="closeModalContinue()">Continuer</button>
            <button onclick="closeModalRestart()">Recommencer</button>
        </div>
    </div>

    <button class="global-ranking-btn" onclick="toggleGlobalModal()">üèÜ Global</button>

    <div id="globalRankingModal" class="modal" style="top: 50%; transform: translateY(-50%); left: 50%;"> 
        <button class="close-btn" onclick="toggleGlobalModal()">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 6L6 18M6 6L18 18" />
            </svg>
        </button>
        <h3>üèÜ Classement Global (Cumul√©)</h3>
        <ul id="globalRankingList"></ul>
    </div>

    <script>
        const rankings = {
            "100": [
                "<span>Classement 5√®mes</span>",
                "1. Rouda√Øna (5B) <span>77</span>",
                "2. Jarod (5F) <span>64</span>",
                "3. Rafael (5A) <span>43</span>",
                "4. Emmanuel (5E) <span>41</span>",
                "5. Rapha√´l (5B) <span>35</span>",
                "5. Lily-Rose (5E) <span>35</span>",
                "7. Manech (5B) <span>33</span>"
            ],
            "90": [
                "<span>Classement 5√®mes</span>",
                "1. Rouda√Øna (5B) <span>60</span>",
                "1. Emmanuel (5E) <span>37</span>"
            ],
            "80": [
                "<span>Classement 5√®mes</span>",
                "1. Emmanuel (5E) <span>35</span>",
                "2. Madhi (5E) <span>32</span>"
            ],
            "60": [
                "<span>Classement 5√®mes</span>",
                "1. Naelle (5B) <span>27</span>",
                "2. Madhi (5E) <span>24</span>"
            ],
            "50": [
                "<span>Classement 5√®mes</span>",
                "1. Rouda√Øna (5B) <span>41</span>",
                "2. Ayyoub (5e5) <span>34</span>",
                "2. Lily-Rose (5E) <span>34</span>",
                "4. Emmanuel (5E) <span>26</span>",
                "5. Madhi (5E) <span>25</span>",
                "6. Naelle (5B) <span>23</span>"
            ],
            "40": [
                "<span>Classement 5√®mes</span>",
                "1. Rouda√Øna (5B) <span>32</span>",
                "2. Rafael (5A) <span>31</span>",
                "2. Lily-Rose (5E) <span>31</span>",
                "4. Emmanuel (5E) <span>23</span>",
                "5. Madhi (5E) <span>16</span>"
            ],
            "30": [
                "<span>Classement 5√®mes</span>",
                "1. Rouda√Øna (5B) <span>26</span>",
                "1. Naelle (5B) <span>26</span>",
                "1. Lily-Rose (5E) <span>26</span>",
                "1. Rafael (5A) <span>26</span>",
                "5. Jarod (5F) <span>24</span>",
                "5. Ayyoub (5e5) <span>24</span>",
                "7. Loum√©o & Thomas (5D) <span>23</span>",
                "8. Mehdi (5A) <span>22</span>",
                "9. J√©r√©my (5E) <span>21</span>",
                "9. Meyssa (5D) <span>21</span>",
                "9. Noham (5F) <span>21</span>",
                "12. Maeva (5e5) <span>20</span>",
                "12. Jarod (5F) & Cristian (5D) <span>20</span>",
                "12. Jayram (5F) <span>20</span>",
                "15. Mathis (5D) <span>19</span>",
                "15. Madhi (5E) <span>19</span>",
                "15. Kahina (5B) <span>19</span>",
                "18. Yahya (5B) <span>18</span>",
                "18. Emmanuel (5E) <span>18</span>",
                "20. Mme Butin <span>17</span>",
                "21. Madjid (5B) <span>16</span>"
            ],
            "25": [
                "<span>Classement 5√®mes</span>",
                "1. Rouda√Øna (5B) <span>21</span>",
                "1. Lily-Rose (5E) <span>21</span>",
                "1. Rafael (5A) <span>21</span>",
                "4. Ayyoub (5e5) <span>20</span>",
                "4. Noa (5e5) <span>20</span>",
                "6. Madhi (5E) <span>18</span>",
                "7. Jarod (5F) <span>16</span>",
                "8. Mehdi (5A) <span>13</span>"
            ],
            "20": [
                "<span>Classement 5√®mes</span>",
                "1. Lily-Rose (5E) <span>17</span>",
                "1. Rouda√Øna (5B) <span>17</span>",
                "1. Djilali (5e5) <span>17</span>",
                "1. Noa (5e5) <span>17</span>",
                "1. Ayyoub (5e5) <span>17</span>",
                "1. Rafael (5A) <span>17</span>",
                "1. Naila (5e5) <span>17</span>",
                "1. Jarod (5F) <span>16</span>",
                "9. Manon & Ange-Emmanuella (5e5) <span>16</span>",
                "9. Issa (5e5) <span>16</span>",
                "9. Jahid (5e5) <span>16</span>",
                "9. Ma√´llys & Elena (5E) <span>16</span>",
                "9. Neema (5A) <span>16</span>",
                "9. Kahina (5B) <span>16</span>",
                "9. Elios (5F) <span>16</span>",
                "16. Jayram (5F) <span>15</span>",
                "17. Yahya (5B) <span>13</span>",
                "17. Emmanuel (5E) <span>13</span>",
                "17. L√©o (5A) <span>13</span>",
                "17. Mehdi (5A) <span>13</span>",
                "21. Madhi (5E) <span>12</span>"
            ],
            "10": [
                "<span>Classement 5√®mes</span>",
                "1. Yohan & Djilali (5e5) <span>9</span>",
                "1. Ayyoub (5e5) <span>9</span>",
                "1. Issa (5e5) <span>9</span>",
                "1. Noa (5e5) <span>9</span>",
                "1. Jahid (5e5) <span>9</span>",
                "1. J√©r√©my (5E) <span>9</span>",
                "1. Madhi (5E) <span>9</span>",
                "1. Jarod (5F) & Cristian (5D) <span>9</span>",
                "1. Meyssa (5D) & Ines (5E) <span>9</span>",
                "1. Jayram (5F) <span>9</span>",
                "1. Mathis (5D) & Elios (5F) <span>9</span>",
                "1. Soumaya (5F) & M√©lina (5E) <span>9</span>",
                "1. Noham (5F) <span>9</span>",
                "1. Lily-Rose (5E) <span>9</span>",
                "1. Rouda√Øna (5B) <span>9</span>",
                "1. Naelle (5B) <span>9</span>",
                "1. Kahina (5B) <span>9</span>",
                "1. Neema (5A) <span>9</span>",
                "1. Yahya (5B) <span>9</span>",
                "1. Maya (5B) <span>9</span>",
                "1. Mehdi (5A) <span>9</span>",
                "1. L√©o (5A) <span>9</span>",
                "1. Emmanuel (5E) <span>9</span>",
                "1. Rafael (5A) <span>9</span>",
                "1. Manon & Ange-Emmanuella (5e5) <span>9</span>",
                "1. Rapha√´l (5B) <span>9</span>",
                "1. Thomas (5D) <span>9</span>",
                "1. Naila (5e5) <span>9</span>"
            ]
        };

        const goldScores = {
            "10": 9,
            "20": 17,
            "25": 21,
            "30": 26,
            "40": 32,
            "50": 41,
            "60": 49,
            "70": 57,
            "80": 64,
            "90": 70,
            "100": 77
        };

        // --- CLASSEMENT GLOBAL (D√©finitions) ---
        const GLOBAL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT1neNKra59CewHg8kRJvnUNNiGW5_pat_SZF4_5xmhgpxn1st0A-Sk9mIUXu5YpRFVKcgf-E7eT47H/pub?gid=1245136924&single=true&output=csv';
        let globalRankingData = [];

        // Indices des colonnes (A=0, B=1)
        const NAME_INDEX = 0; 
        const CLASS_INDEX = 1;
        const CUMULATIVE_SCORE_INDEX = 15;

        // REGEX pour extraire la colonne 15 :
        const COLUMN_15_REGEX = /^(?:(?:"[^"]*"|[^,]*),){15}("[^"]*"|[^,]*)/;


        const grid = document.getElementById("grid");
        const selectedNumbersDisplay = document.getElementById("selectedNumbers");
        const counter = document.getElementById("counter");
        let selectedNumber = null;
        let availableNumbers = new Set();
        let lastSelectedCell = null;
        let turnCount = 0;
        let selectedNumbersList = [];
        let selectedCells = [];

        function closeModalContinue() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("gameOverModal").style.display = "none";
        }

        function closeModalRestart() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("gameOverModal").style.display = "none";
            resetSequence();
        }

        function closeAllModals() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("globalRankingModal").style.display = "none";
            document.getElementById("rankingModal").style.display = "none";
            document.getElementById("gameOverModal").style.display = "none";
        }

        function copySequence() {
            const sequenceText = selectedNumbersList.join(" - ");
            navigator.clipboard.writeText(sequenceText).then(() => {
                const btn = document.querySelector('.copy-icon-btn');
                const svg = btn.querySelector('svg');
                const originalHTML = svg.innerHTML;
                
                // Changer en ic√¥ne de validation
                svg.innerHTML = '<path d="M20 6L9 17l-5-5"></path>';
                
                setTimeout(() => {
                    svg.innerHTML = originalHTML;
                }, 2000);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
            });
        }

        function toggleModal() {
            const modal = document.getElementById("rankingModal");
            const count = document.getElementById("numberCount").value;
            const rankingList = document.getElementById("rankingList");
            rankingList.innerHTML = "";

            if (modal.style.display === "block") {
                modal.style.display = "none";
            } else {
                if (rankings[count]) {
                    rankings[count].forEach(entry => {
                        let li = document.createElement("li");
                        li.innerHTML = entry;
                        const scoreMatch = entry.match(/<span>(\d+)<\/span>/);
                        if (scoreMatch) {
                            const score = parseInt(scoreMatch[1], 10);
                            if (score >= goldScores[count]) {
                                li.style.color = "#D4AF37";
                            }
                        }
                        rankingList.appendChild(li);
                    });
                } else {
                    let li = document.createElement("li");
                    li.textContent = "Pas de classement disponible.";
                    rankingList.appendChild(li);
                }
                modal.style.display = "block";
            }
        }

        function toggleGlobalModal() {
            const modal = document.getElementById("globalRankingModal");
            const overlay = document.getElementById("overlay");
            const rankingList = document.getElementById("globalRankingList");

            if (modal.style.display === "block") {
                closeAllModals(); 
            } else {
                document.getElementById("rankingModal").style.display = "none";
                document.getElementById("gameOverModal").style.display = "none";

                rankingList.innerHTML = "";
                
                globalRankingData.forEach(li => rankingList.appendChild(li.cloneNode(true)));
                
                modal.style.display = "block";
                overlay.style.display = "block"; // Affiche l'overlay pour bloquer le jeu
            }
        }

        function parseGlobalCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            const dataLines = lines.slice(1); 
            const extractedData = [];
            
            dataLines.forEach((line, index) => {
                const parts = line.split(',');
                
                const nom = parts[NAME_INDEX] ? parts[NAME_INDEX].trim().replace(/"/g, '') : '';
                let classe = parts[CLASS_INDEX] ? parts[CLASS_INDEX].trim().replace(/"/g, '') : '';
                
                if (classe === '') {
                    classe = 'Professeur'; 
                }

                // --- NOUVEAU TRAITEMENT POUR LA COLONNE DE SCORE (INDEX 15 / COLONNE P) ---
                let scoreTextRaw = '';
                const match = line.match(COLUMN_15_REGEX);
                
                if (match && match[1]) {
                    scoreTextRaw = match[1].trim();
                } else {
                    scoreTextRaw = parts[CUMULATIVE_SCORE_INDEX] || '';
                }

                // 1. Enl√®ve tous les guillemets.
                let scoreTextClean = scoreTextRaw.replace(/"/g, '').trim();
                
                // 2. Prot√®ge la virgule d√©cimale en la rempla√ßant par un jeton temporaire.
                scoreTextClean = scoreTextClean.replace(',', 'DECIMAL_POINT_PLACEHOLDER');
                
                // 3. Supprime tous les points et espaces (s√©parateurs de milliers potentiels : 1.030 ou 1 030).
                scoreTextClean = scoreTextClean.replace(/\./g, ''); 
                scoreTextClean = scoreTextClean.replace(/\s/g, ''); 
                
                // 4. R√©tablit le point d√©cimal pour que parseFloat fonctionne.
                scoreTextClean = scoreTextClean.replace('DECIMAL_POINT_PLACEHOLDER', '.');
                
                const score = parseFloat(scoreTextClean); 
                
                // D√©commentez la ligne ci-dessous si le probl√®me persiste pour voir le r√©sultat du parsing :
                // console.log(`DEBUG Ligne ${index + 1}: Nom='${nom}'. Raw: '${scoreTextRaw}'. Clean: '${scoreTextClean}'. Pars√©: ${score}.`);
                
                if (nom && !isNaN(score) && score !== 0) { // On ignore les scores √† 0
                    extractedData.push({ nom, classe, score });
                }
            });
            
            // 1. Triage des donn√©es : (le plus haut score est 1er)
            extractedData.sort((a, b) => b.score - a.score);

            // 2. Construction des √©l√©ments HTML (li)
            const list = [];
            extractedData.forEach((data, index) => {
                const rang = index + 1;
                const badge = rang === 1 ? 'üèÜ' : rang === 2 ? 'ü•à' : rang === 3 ? 'ü•â' : rang;
                
                const scoreValue = data.score;
                // AFFICHAGE : Affiche un chiffre apr√®s la virgule si n√©cessaire, sinon affiche l'entier.
                const scoreDisplay = scoreValue % 1 === 0 ? scoreValue.toFixed(0) : scoreValue.toFixed(1); 

                let li = document.createElement("li");
                li.classList.add('ranking-entry');
                li.setAttribute('data-rank', rang);
                
                li.innerHTML = `
                    <div class="rank-badge">${badge}</div>
                    <div class="info-group">
                        <div class="name-class">
                            <span class="rank-name">${data.nom}</span>
                            <span class="rank-class">${data.classe}</span>
                        </div>
                        <div class="rank-score">
                            <span class="score-value">${scoreDisplay}</span>
                            <span class="score-unit">points</span>
                        </div>
                    </div>
                `;
                if (rang <= 3) {
                    li.classList.add('top-three');
                }
                if (data.classe === 'Professeur') {
                    li.classList.add('teacher-entry');
                }

                list.push(li);
            });

            return list;
        }

        async function loadRankings() {
            try {
                const response = await fetch(GLOBAL_CSV_URL);
                
                if (!response.ok) {
                     throw new Error(`Erreur HTTP lors du chargement: ${response.status}`);
                }
                
                const csvText = await response.text();
                globalRankingData = parseGlobalCSV(csvText); 
                
            } catch (error) {
                console.error("Erreur critique de chargement/parsing du classement global :", error);
                let li = document.createElement("li");
                li.textContent = "Erreur de chargement du classement. (V√©rifiez la publication Sheets)";
                globalRankingData = [li];
            }
            generateGrid();
        }

        function generateGrid() {
            const count = parseInt(document.getElementById("numberCount").value, 10);
            grid.innerHTML = "";
            selectedNumbersDisplay.innerHTML = "";
            selectedNumbersDisplay.style.display = "none";
            counter.textContent = "0";
            availableNumbers = new Set([...Array(count).keys()].map(i => i + 1));
            selectedNumber = null;
            lastSelectedCell = null;
            turnCount = 0;
            selectedNumbersList = [];
            selectedCells = [];

            let columns, rows, cellSize;
            switch(count) {
                case 10: columns = 5; rows = 2; cellSize = '60px'; break;
                case 20: columns = 5; rows = 4; cellSize = '60px'; break;
                case 25: columns = 5; rows = 5; cellSize = '60px'; break;
                case 30: columns = 6; rows = 5; cellSize = '60px'; break;
                case 40: columns = 8; rows = 5; cellSize = '60px'; break;
                case 50: columns = 10; rows = 5; cellSize = '60px'; break;
                case 60: columns = 10; rows = 6; cellSize = '60px'; break;
                case 70: columns = 10; rows = 7; cellSize = '60px'; break;
                case 80: columns = 10; rows = 8; cellSize = '60px'; break;
                case 90: columns = 10; rows = 9; cellSize = '60px'; break;
                case 100: columns = 10; rows = 10; cellSize = '50px'; break;
                default: columns = 8; rows = 5; cellSize = '60px';
            }
            grid.style.gridTemplateColumns = `repeat(${columns}, ${cellSize})`;

            for (let i = 1; i <= count; i++) {
                let cell = document.createElement("div");
                cell.classList.add("number");
                cell.textContent = i;
                cell.style.height = cellSize;
                cell.style.width = cellSize;
                cell.addEventListener("click", () => selectNumber(i, cell));
                grid.appendChild(cell);
            }
            grid.style.visibility = "visible";

            document.getElementById("rankingModal").style.display = "none";
        }

        function selectNumber(num, cell) {
            if (!selectedNumber || num % selectedNumber === 0 || selectedNumber % num === 0) {
                selectedNumber = num;
                cell.classList.add("selected", "disabled");
                turnCount++;
                lastSelectedCell = cell;
                availableNumbers.delete(num);
                selectedNumbersList.push(num);
                selectedCells.push(cell);
                selectedNumbersDisplay.textContent = selectedNumbersList.join(" - ");
                selectedNumbersDisplay.style.display = "block";
                counter.textContent = selectedNumbersList.length;

                counter.classList.add('glow');
                setTimeout(() => {
                    counter.classList.remove('glow');
                }, 1000);
                
                checkGameOver();
            }
        }

        function undoLastMove() {
            if (selectedNumbersList.length > 0) {
                let lastNum = selectedNumbersList.pop();
                let lastCell = selectedCells.pop();
                if (lastCell) {
                    lastCell.classList.remove("selected", "disabled");
                }
                selectedNumber = selectedNumbersList.length > 0 ? selectedNumbersList[selectedNumbersList.length - 1] : null;
                availableNumbers.add(lastNum);
                selectedNumbersDisplay.textContent = selectedNumbersList.join(" - ");
                counter.textContent = selectedNumbersList.length;
                if (selectedNumbersList.length === 0) {
                    selectedNumbersDisplay.style.display = "none";
                }
            }
        }

        function resetSequence() {
            selectedNumber = null;
            selectedNumbersList = [];
            selectedCells.forEach(cell => cell.classList.remove("selected", "disabled"));
            selectedCells = [];
            availableNumbers = new Set([...Array(parseInt(document.getElementById("numberCount").value, 10)).keys()].map(i => i + 1));
            selectedNumbersDisplay.textContent = "";
            selectedNumbersDisplay.style.display = "none";
            counter.textContent = "0";
        }

        function checkGameOver() {
            let possibleMoves = Array.from(availableNumbers).some(n => n % selectedNumber === 0 || selectedNumber % n === 0);
            if (!possibleMoves) {
                if (lastSelectedCell) {
                    lastSelectedCell.classList.add("selected");
                }
                const finalScore = selectedNumbersList.length;
                const count = document.getElementById("numberCount").value;
                const goldScore = goldScores[count];
                
                setTimeout(() => {
                    const modal = document.getElementById("gameOverModal");
                    const overlay = document.getElementById("overlay");
                    const modalTitle = document.getElementById("modalTitle");
                    const modalMessage = document.getElementById("modalMessage");
                    const modalScore = document.getElementById("modalScore");
                    const modalSequence = document.getElementById("modalSequence");
                    
                    modalSequence.textContent = selectedNumbersList.join(" - ");
                    
                    if (finalScore >= goldScore) {
                        modalTitle.textContent = "F√©licitations !";
                        modalMessage.textContent = "Vous avez trouv√© la s√©quence maximale !";
                        modalScore.textContent = finalScore;
                        modalScore.className = "score gold";
                        lancerConfettis();
                    } else {
                        modalTitle.textContent = "Partie termin√©e !";
                        modalMessage.textContent = `Longueur maximale possible : ${goldScore}`;
                        modalScore.textContent = finalScore;
                        modalScore.className = "score";
                    }
                    
                    overlay.style.display = "block";
                    modal.style.display = "block";

                    setTimeout(() => {
                        modalScore.classList.add('glow');
                        setTimeout(() => {
                            modalScore.classList.remove('glow');
                        }, 800);
                    }, 100);
                }, 200);
            }
        }

        function lancerConfettis() {
            const duration = 2500;
            const animationEnd = Date.now() + duration;

            (function frame() {
                const timeLeft = animationEnd - Date.now();

                for (let i = 0; i < 20; i++) {
                    const confetti = document.createElement("div");
                    confetti.className = "confetti";

                    const size = Math.random() * 8 + 4;
                    const left = Math.random() * 100;
                    const rotate = Math.random() * 360;

                    confetti.style.width = `${size}px`;
                    confetti.style.height = `${size * 0.4}px`;
                    confetti.style.left = `${left}vw`;
                    confetti.style.transform = `rotate(${rotate}deg)`;
                    confetti.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 60%)`;

                    document.body.appendChild(confetti);

                    const fall = (Math.random() * 1) + 0.5;
                    confetti.animate([
                        { transform: `translateY(0) rotate(${rotate}deg)` },
                        { transform: `translateY(100vh) rotate(${rotate + 180}deg)` }
                    ], {
                        duration: fall * 2000,
                        easing: "linear"
                    });

                    setTimeout(() => confetti.remove(), fall * 2000);
                }

                if (timeLeft > 0) requestAnimationFrame(frame);
            })();
        }

        window.addEventListener("DOMContentLoaded", () => {
            const select = document.getElementById("numberCount");
            
            const savedVersion = localStorage.getItem("gameVersion");
            if (savedVersion && select) select.value = savedVersion;
            
            loadRankings(); 
            
            select.addEventListener("change", (e) => {
                const version = e.target.value;
                localStorage.setItem("gameVersion", version);
                generateGrid();
            });
        });
    </script>
</body>
</html>
